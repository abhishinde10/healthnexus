const request = require('supertest');\nconst { app } = require('../../server');\nconst User = require('../../src/models/User');\n\ndescribe('Authentication Integration Tests', () => {\n  const validUserData = {\n    firstName: 'John',\n    lastName: 'Doe',\n    email: 'john.doe@test.com',\n    password: 'TestPassword123!',\n    role: 'patient'\n  };\n\n  describe('POST /api/v1/auth/register', () => {\n    it('should register a new user successfully', async () => {\n      const response = await request(app)\n        .post('/api/v1/auth/register')\n        .send(validUserData);\n\n      expect(response.status).toBe(201);\n      expect(response.body.success).toBe(true);\n      expect(response.body.data.email).toBe(validUserData.email);\n      expect(response.body.token).toBeDefined();\n      expect(response.body.data.password).toBeUndefined();\n    });\n\n    it('should not register user with invalid email', async () => {\n      const invalidData = { ...validUserData, email: 'invalid-email' };\n      \n      const response = await request(app)\n        .post('/api/v1/auth/register')\n        .send(invalidData);\n\n      expect(response.status).toBe(400);\n      expect(response.body.success).toBe(false);\n    });\n\n    it('should not register user with weak password', async () => {\n      const invalidData = { ...validUserData, password: '123' };\n      \n      const response = await request(app)\n        .post('/api/v1/auth/register')\n        .send(invalidData);\n\n      expect(response.status).toBe(400);\n      expect(response.body.success).toBe(false);\n    });\n\n    it('should not register duplicate email', async () => {\n      // First registration\n      await request(app)\n        .post('/api/v1/auth/register')\n        .send(validUserData);\n\n      // Second registration with same email\n      const response = await request(app)\n        .post('/api/v1/auth/register')\n        .send(validUserData);\n\n      expect(response.status).toBe(400);\n      expect(response.body.success).toBe(false);\n    });\n  });\n\n  describe('POST /api/v1/auth/login', () => {\n    beforeEach(async () => {\n      // Create a user for login tests\n      await request(app)\n        .post('/api/v1/auth/register')\n        .send(validUserData);\n    });\n\n    it('should login with valid credentials', async () => {\n      const response = await request(app)\n        .post('/api/v1/auth/login')\n        .send({\n          email: validUserData.email,\n          password: validUserData.password\n        });\n\n      expect(response.status).toBe(200);\n      expect(response.body.success).toBe(true);\n      expect(response.body.token).toBeDefined();\n      expect(response.body.data.email).toBe(validUserData.email);\n    });\n\n    it('should not login with invalid password', async () => {\n      const response = await request(app)\n        .post('/api/v1/auth/login')\n        .send({\n          email: validUserData.email,\n          password: 'wrongpassword'\n        });\n\n      expect(response.status).toBe(401);\n      expect(response.body.success).toBe(false);\n    });\n\n    it('should not login with non-existent email', async () => {\n      const response = await request(app)\n        .post('/api/v1/auth/login')\n        .send({\n          email: 'nonexistent@test.com',\n          password: validUserData.password\n        });\n\n      expect(response.status).toBe(401);\n      expect(response.body.success).toBe(false);\n    });\n  });\n\n  describe('GET /api/v1/auth/me', () => {\n    let token;\n    let userId;\n\n    beforeEach(async () => {\n      const response = await request(app)\n        .post('/api/v1/auth/register')\n        .send(validUserData);\n      \n      token = response.body.token;\n      userId = response.body.data._id;\n    });\n\n    it('should get current user with valid token', async () => {\n      const response = await request(app)\n        .get('/api/v1/auth/me')\n        .set('Authorization', `Bearer ${token}`);\n\n      expect(response.status).toBe(200);\n      expect(response.body.success).toBe(true);\n      expect(response.body.data.email).toBe(validUserData.email);\n      expect(response.body.data._id).toBe(userId);\n    });\n\n    it('should not get user without token', async () => {\n      const response = await request(app)\n        .get('/api/v1/auth/me');\n\n      expect(response.status).toBe(401);\n      expect(response.body.success).toBe(false);\n    });\n\n    it('should not get user with invalid token', async () => {\n      const response = await request(app)\n        .get('/api/v1/auth/me')\n        .set('Authorization', 'Bearer invalid-token');\n\n      expect(response.status).toBe(401);\n      expect(response.body.success).toBe(false);\n    });\n  });\n\n  describe('PUT /api/v1/auth/profile', () => {\n    let token;\n\n    beforeEach(async () => {\n      const response = await request(app)\n        .post('/api/v1/auth/register')\n        .send(validUserData);\n      \n      token = response.body.token;\n    });\n\n    it('should update user profile successfully', async () => {\n      const updateData = {\n        firstName: 'Jane',\n        phone: '+1234567890'\n      };\n\n      const response = await request(app)\n        .put('/api/v1/auth/profile')\n        .set('Authorization', `Bearer ${token}`)\n        .send(updateData);\n\n      expect(response.status).toBe(200);\n      expect(response.body.success).toBe(true);\n      expect(response.body.data.firstName).toBe(updateData.firstName);\n      expect(response.body.data.phone).toBe(updateData.phone);\n    });\n\n    it('should not update profile with invalid data', async () => {\n      const invalidData = {\n        firstName: '', // Empty name\n        email: 'invalid-email' // Invalid email format\n      };\n\n      const response = await request(app)\n        .put('/api/v1/auth/profile')\n        .set('Authorization', `Bearer ${token}`)\n        .send(invalidData);\n\n      expect(response.status).toBe(400);\n      expect(response.body.success).toBe(false);\n    });\n  });\n\n  describe('POST /api/v1/auth/forgotpassword', () => {\n    beforeEach(async () => {\n      await request(app)\n        .post('/api/v1/auth/register')\n        .send(validUserData);\n    });\n\n    it('should send password reset email for existing user', async () => {\n      const response = await request(app)\n        .post('/api/v1/auth/forgotpassword')\n        .send({ email: validUserData.email });\n\n      expect(response.status).toBe(200);\n      expect(response.body.success).toBe(true);\n      expect(response.body.message).toContain('email sent');\n    });\n\n    it('should handle non-existent email gracefully', async () => {\n      const response = await request(app)\n        .post('/api/v1/auth/forgotpassword')\n        .send({ email: 'nonexistent@test.com' });\n\n      expect(response.status).toBe(404);\n      expect(response.body.success).toBe(false);\n    });\n  });\n});\n\ndescribe('User Model Tests', () => {\n  it('should hash password before saving', async () => {\n    const userData = {\n      firstName: 'Test',\n      lastName: 'User',\n      email: 'test@example.com',\n      password: 'TestPassword123!'\n    };\n\n    const user = new User(userData);\n    await user.save();\n\n    expect(user.password).not.toBe(userData.password);\n    expect(user.password).toMatch(/^\\$2[aby]\\$.{56}$/);\n  });\n\n  it('should validate password correctly', async () => {\n    const userData = {\n      firstName: 'Test',\n      lastName: 'User',\n      email: 'test@example.com',\n      password: 'TestPassword123!'\n    };\n\n    const user = new User(userData);\n    await user.save();\n\n    const isMatch = await user.matchPassword('TestPassword123!');\n    const isNotMatch = await user.matchPassword('WrongPassword');\n\n    expect(isMatch).toBe(true);\n    expect(isNotMatch).toBe(false);\n  });\n\n  it('should generate JWT token', async () => {\n    const userData = {\n      firstName: 'Test',\n      lastName: 'User',\n      email: 'test@example.com',\n      password: 'TestPassword123!'\n    };\n\n    const user = new User(userData);\n    await user.save();\n\n    const token = user.getSignedJwtToken();\n    expect(token).toBeDefined();\n    expect(typeof token).toBe('string');\n    expect(token.split('.')).toHaveLength(3);\n  });\n});